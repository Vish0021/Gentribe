rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user matches the ID
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users collection: Users can read/write their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Jobs collection
    match /jobs/{jobId} {
      // Anyone can read jobs (needed for public listing)
      allow read: if true;
      
      // Only employers can create (checked via logic, but here we enforce ownership)
      // and update/delete their own jobs
      allow create: if isAuthenticated() && request.resource.data.employerId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.employerId == request.auth.uid;
    }

    // Applications collection
    match /applications/{applicationId} {
      // Job seekers can read their own applications
      // Employers can read applications for their jobs (this is complex in rules without denormalization, 
      // but for now we focus on the requirement: "job seekers to apply and view only their own applications")
      
      // Allow create if authenticated and applying for self
      allow create: if isAuthenticated() && request.resource.data.applicantId == request.auth.uid;
      
      // Allow read if user is the applicant
      allow read: if isAuthenticated() && resource.data.applicantId == request.auth.uid;
      
      // Note: In a real app, employers need to read applications too. 
      // We would add: || (isAuthenticated() && get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.employerId == request.auth.uid)
      // But query rules require fields to be on the doc often. 
      // For this specific request, "allow job seekers to apply and view only their own applications" is key.
    }
  }
}
